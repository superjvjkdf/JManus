import{P as ae,r as f,_ as se,B as M,c as A,Q as le}from"./index-DDyEo--X.js";import{P as b}from"./plan-template-with-tool-api-service-BZqjfE8u.js";import{L as w}from"./llm-check-CJy4TeZw.js";const ke=ae("task",()=>{const t=f(null),e=f(""),a=f(!1);return{currentTask:t,taskToInput:e,hasVisitedHome:a,setTask:p=>{if(console.log("[TaskStore] setTask called with prompt:",p),!p.trim()){console.warn("[TaskStore] Empty prompt provided, not creating task");return}const C={prompt:p,timestamp:Date.now(),processed:!1};t.value=C,console.log("[TaskStore] Task set, currentTask.value:",t.value)},setTaskToInput:p=>{console.log("[TaskStore] setTaskToInput called with prompt:",p),e.value=p,console.log("[TaskStore] Task to input set:",e.value)},getAndClearTaskToInput:()=>{const p=e.value;return e.value="",console.log("[TaskStore] getAndClearTaskToInput returning:",p),p},markTaskAsProcessed:()=>{console.log("[TaskStore] markTaskAsProcessed called, current task:",t.value),t.value?(t.value.processed=!0,console.log("[TaskStore] Task marked as processed:",t.value)):console.log("[TaskStore] No current task to mark as processed")},clearTask:()=>{t.value=null},hasUnprocessedTask:()=>{const p=t.value&&!t.value.processed;return console.log("[TaskStore] hasUnprocessedTask check - currentTask:",t.value,"result:",p),p},markHomeVisited:()=>{a.value=!0,localStorage.setItem("hasVisitedHome","true")},checkHomeVisited:()=>{const p=localStorage.getItem("hasVisitedHome");return a.value=p==="true",a.value},resetHomeVisited:()=>{a.value=!1,localStorage.removeItem("hasVisitedHome")},emitPlanExecutionRequested:p=>{console.log("[TaskStore] emitPlanExecutionRequested called with payload:",p),window.dispatchEvent(new CustomEvent("plan-execution-requested",{detail:p}))},setTaskRunning:p=>{console.log("[TaskStore] setTaskRunning called with planId:",p),t.value?(t.value.planId=p,t.value.isRunning=!0,console.log("[TaskStore] Updated existing task:",t.value)):(t.value={prompt:"",timestamp:Date.now(),processed:!1,planId:p,isRunning:!0},console.log("[TaskStore] Created new task for running state:",t.value))},stopCurrentTask:async()=>{if(console.log("[TaskStore] stopCurrentTask called"),t.value&&t.value.isRunning&&t.value.planId)try{const{DirectApiService:p}=await se(async()=>{const{DirectApiService:C}=await Promise.resolve().then(()=>ie);return{DirectApiService:C}},void 0);return await p.stopTask(t.value.planId),console.log("[TaskStore] Task stopped successfully"),t.value.isRunning=!1,!0}catch(p){return console.error("[TaskStore] Failed to stop task:",p),!1}return!1},hasRunningTask:()=>{const p=t.value&&t.value.isRunning;return console.log("[TaskStore] hasRunningTask check - result:",p),p}}});class ne{isCollapsed=!1;currentTab="list";toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(e){this.currentTab=e}}const we=M(new ne);class re{isCollapsed=!1;selectMemoryId="";conversationId=null;loadMessages=()=>{};intervalId=void 0;CONVERSATION_ID_KEY="currentConversationId";constructor(){this.loadConversationIdFromStorage()}loadConversationIdFromStorage(){try{const e=localStorage.getItem(this.CONVERSATION_ID_KEY);e&&(this.conversationId=e,console.log("[MemoryStore] Restored conversationId from localStorage:",e))}catch(e){console.warn("[MemoryStore] Failed to load conversationId from localStorage:",e)}}saveConversationIdToStorage(){try{this.conversationId?(localStorage.setItem(this.CONVERSATION_ID_KEY,this.conversationId),console.log("[MemoryStore] Saved conversationId to localStorage:",this.conversationId)):(localStorage.removeItem(this.CONVERSATION_ID_KEY),console.log("[MemoryStore] Removed conversationId from localStorage"))}catch(e){console.warn("[MemoryStore] Failed to save conversationId to localStorage:",e)}}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(e){this.toggleSidebar(),this.selectMemoryId=e}setMemory(e){this.selectMemoryId=e}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}setConversationId(e){this.conversationId=e,this.saveConversationIdToStorage()}clearConversationId(){this.conversationId=null,this.saveConversationIdToStorage()}getConversationId(){return this.conversationId}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(e){this.loadMessages=e}}const L=M(new re);class H{static BASE_URL="/api/executor";static async sendMessage(e){return w.withLlmCheck(async()=>{const a={...e,requestSource:"VUE_DIALOG"},s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()})}static async sendMessageWithDefaultPlan(e,a="VUE_DIALOG"){const s="default-plan-id-001000222",r={userRequirement:e.input};return this.executeByToolName(s,r,e.uploadedFiles,e.uploadKey,a)}static async executeByToolName(e,a,s,r,n="VUE_DIALOG",l){return w.withLlmCheck(async()=>{console.log("[DirectApiService] executeByToolName called with:",{toolName:e,replacementParams:a,uploadedFiles:s,uploadKey:r,requestSource:n,serviceGroup:l});const i={toolName:e,requestSource:n};L.conversationId&&(i.conversationId=L.conversationId,console.log("[DirectApiService] Including conversationId from memoryStore:",L.conversationId)),l&&(i.serviceGroup=l,console.log("[DirectApiService] Including serviceGroup:",l)),a&&Object.keys(a).length>0&&(i.replacementParams=a,console.log("[DirectApiService] Including replacement params:",a)),s&&s.length>0&&(i.uploadedFiles=s,console.log("[DirectApiService] Including uploaded files:",s.length)),r&&(i.uploadKey=r,console.log("[DirectApiService] Including uploadKey:",r)),console.log("[DirectApiService] Making request to:",`${this.BASE_URL}/executeByToolNameAsync`),console.log("[DirectApiService] Request body:",i);const c=await fetch(`${this.BASE_URL}/executeByToolNameAsync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(console.log("[DirectApiService] Response status:",c.status,c.ok),!c.ok){const h=await c.text();throw console.error("[DirectApiService] Request failed:",h),new Error(`Failed to execute: ${c.status}`)}const v=await c.json();return console.log("[DirectApiService] executeByToolName response:",v),v})}static async stopTask(e){return w.withLlmCheck(async()=>{console.log("[DirectApiService] Stopping task for planId:",e);const a=await fetch(`${this.BASE_URL}/stopTask/${e}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!a.ok){const s=await a.json().catch(()=>({}));throw new Error(s.error||`Failed to stop task: ${a.status}`)}return await a.json()})}}const ie=Object.freeze(Object.defineProperty({__proto__:null,DirectApiService:H},Symbol.toStringTag,{value:"Module"}));class ce{static PLAN_TEMPLATE_URL="/api/plan-template";static async executePlan(e,a,s,r,n,l="VUE_SIDEBAR"){return w.withLlmCheck(async()=>(console.log("[PlanActApiService] executePlan called with:",{planTemplateId:e,rawParam:a,uploadedFiles:s,replacementParams:r,uploadKey:n,requestSource:l}),a&&(r||(r={}),r.userRequirement=a,console.log("[PlanActApiService] Added rawParam to replacementParams:",a)),await H.executeByToolName(e,r,s,n,l)))}static async getPlanVersions(e){const a=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});if(!a.ok)throw new Error(`Failed to get plan versions: ${a.status}`);return await a.json()}static async getAllPlanTemplates(){const e=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!e.ok)throw new Error(`Failed to get plan template list: ${e.status}`);return await e.json()}}function pe(){const t=M({title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",accessLevel:"editable",serviceGroup:""}),e=f(!1),a=f(null),s=f(!1),r=f(!1),n=f([]),l=f(-1),i=f([]),c=f(null),v=f(null),h=()=>t.title,y=()=>t.planType||"dynamic_agent",I=()=>t.serviceGroup||"",E=o=>{t.title=o},D=o=>{t.steps=o||[]},O=o=>{t.planType=o},p=o=>{t.planTemplateId=o},C=o=>{t.serviceGroup=o},N=o=>{o===void 0?delete t.toolConfig:t.toolConfig=o},B=o=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.toolDescription=o},x=o=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableInternalToolcall=o},U=o=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableHttpService=o},q=o=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.inputSchema=o||[]},k=()=>({...t}),G=o=>{r.value=!0;const u=o.accessLevel||(o.readOnly?"readOnly":"editable"),g={title:o.title||"",steps:(o.steps||[]).map(T=>({...T,selectedToolKeys:T.selectedToolKeys??[]})),directResponse:o.directResponse||!1,planType:o.planType||"dynamic_agent",planTemplateId:o.planTemplateId||"",accessLevel:u,serviceGroup:o.serviceGroup||""};o.toolConfig&&(g.toolConfig={...o.toolConfig}),Object.assign(t,g),setTimeout(()=>{r.value=!1},50)},J=()=>{r.value=!0,Object.assign(t,{title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",accessLevel:"editable",serviceGroup:""}),"toolConfig"in t&&delete t.toolConfig,n.value=[],l.value=-1,a.value=null,setTimeout(()=>{r.value=!1},0)},V=()=>{const o=t.accessLevel||(t.readOnly?"readOnly":"editable"),u={title:t.title||"",steps:(t.steps||[]).map(g=>({...g,selectedToolKeys:g.selectedToolKeys??[]})),directResponse:t.directResponse||!1,planType:t.planType||"dynamic_agent",planTemplateId:t.planTemplateId||"",accessLevel:o,serviceGroup:t.serviceGroup||""};return t.toolConfig&&(u.toolConfig={...t.toolConfig}),JSON.stringify(u,null,2)},_=o=>{try{const u=JSON.parse(o);return G(u),!0}catch(u){return a.value=u instanceof Error?u.message:"Invalid JSON format",!1}},j=A(()=>n.value.length>1&&l.value>0),z=A(()=>n.value.length>1&&l.value<n.value.length-1),K=()=>{if(j.value&&l.value>0){l.value--;const o=n.value[l.value]||"";_(o)}},Y=()=>{if(z.value&&l.value<n.value.length-1){l.value++;const o=n.value[l.value]||"";_(o)}},Q=o=>{l.value<n.value.length-1&&(n.value=n.value.slice(0,l.value+1)),n.value.push(o),l.value=n.value.length-1},F=async o=>{if(!o)return a.value="Plan template ID is required",!1;try{e.value=!0,a.value=null;const u=await b.getPlanTemplateConfigVO(o);v.value===o&&(v.value=null,await new Promise(T=>setTimeout(T,0))),s.value=!1,G(u),v.value=o,await new Promise(T=>setTimeout(T,10)),c.value?.planTemplateId===o&&(c.value={...c.value,...u});try{const T=await ce.getPlanVersions(o);n.value=T.versions||[],n.value.length>0?l.value=n.value.length-1:l.value=-1}catch(T){console.warn("Failed to load plan versions:",T),n.value=[],l.value=-1}return!0}catch(u){return a.value=u instanceof Error?u.message:"Failed to load plan template config",console.error("Failed to load plan template config:",u),!1}finally{e.value=!1}},X=async()=>{if(!t.planTemplateId)return a.value="Plan template ID is required",!1;try{e.value=!0,a.value=null;const o=await b.createOrUpdatePlanTemplateWithTool(k());if(o.success){const u=t.planTemplateId;if(u){if(await F(u),c.value?.planTemplateId===u){const T=k();c.value={...c.value,...T}}const g=i.value.findIndex(T=>T.planTemplateId===u);if(g>=0){const T=k();i.value[g]={...i.value[g],...T}}}}return o.success}catch(o){return a.value=o instanceof Error?o.message:"Failed to save plan template config",console.error("Failed to save plan template config:",o),!1}finally{e.value=!1}},Z=()=>{const o=[];return t.planTemplateId?.trim()||o.push("Plan template ID is required"),t.title?.trim()||o.push("Title is required"),(!t.steps||t.steps.length===0)&&o.push("At least one step is required"),{isValid:o.length===0,errors:o}},ee=o=>o?Array.isArray(o)&&o.length>=6?new Date(o[0],o[1]-1,o[2],o[3],o[4],o[5],Math.floor(o[6]/1e6)):typeof o=="string"?new Date(o):new Date:new Date,te=()=>{const o=[];for(const u of i.value){if(!u.toolConfig)continue;const g=u.toolConfig;if(!g.enableInternalToolcall)continue;let T="[]";g.inputSchema&&Array.isArray(g.inputSchema)&&(T=JSON.stringify(g.inputSchema));const $={toolName:u.title||"",toolDescription:g.toolDescription||"",planTemplateId:u.planTemplateId||"",inputSchema:T,enableInternalToolcall:g.enableInternalToolcall??!0,enableHttpService:g.enableHttpService??!1,enableMcpService:g.enableMcpService??!1};u.serviceGroup&&($.serviceGroup=u.serviceGroup),o.push($)}return o},oe=()=>i.value.some(o=>o.toolConfig!==void 0),S=o=>{s.value=!0;try{return o()}finally{setTimeout(()=>{s.value=!1},0)}};return{config:t,isLoading:e,error:a,isUserUpdating:s,needsFullRefresh:r,planVersions:n,currentVersionIndex:l,planTemplateList:i,selectedTemplate:c,currentPlanTemplateId:v,getTitle:h,getPlanType:y,getServiceGroup:I,getConfig:k,setTitle:E,setSteps:D,setPlanType:O,setPlanTemplateId:p,setServiceGroup:C,setToolConfig:N,setToolDescription:B,setEnableInternalToolcall:x,setEnableHttpService:U,setInputSchema:q,setConfig:G,setStepsWithGuard:o=>S(()=>{D(o)}),setToolConfigWithGuard:o=>S(()=>{N(o)}),setToolDescriptionWithGuard:o=>S(()=>{B(o)}),setEnableInternalToolcallWithGuard:o=>S(()=>{x(o)}),setEnableHttpServiceWithGuard:o=>S(()=>{U(o)}),setInputSchemaWithGuard:o=>S(()=>{q(o)}),withUpdateGuard:S,reset:J,load:F,save:X,validate:Z,generateJsonString:V,fromJsonString:_,rollbackVersion:K,restoreVersion:Y,updateVersionsAfterSave:Q,canRollback:j,canRestore:z,parseDateTime:ee,getAllCoordinatorToolsFromTemplates:te,getCoordinatorToolConfig:oe}}let P=null;function W(){return P||(P=pe()),P}class ue{isLoading=!1;errorMessage="";hasTaskRequirementModified=!1;organizationMethod="by_time";templateServiceGroups=new Map;groupCollapseState={};constructor(){const e=localStorage.getItem("sidebarOrganizationMethod");e&&["by_time","by_abc","by_group_time","by_group_abc"].includes(e)&&(this.organizationMethod=e),this.loadGroupCollapseState()}loadGroupCollapseState(){try{const e=localStorage.getItem("sidebarGroupCollapseState");if(e){const a=JSON.parse(e);this.groupCollapseState=a||{}}}catch(e){console.warn("[TemplateStore] Failed to load group collapse state:",e)}}saveGroupCollapseState(){try{localStorage.setItem("sidebarGroupCollapseState",JSON.stringify(this.groupCollapseState))}catch(e){console.warn("[TemplateStore] Failed to save group collapse state:",e)}}toggleGroupCollapse(e){const a=e??"null",s=this.groupCollapseState[a]??!1;this.groupCollapseState[a]=!s,this.saveGroupCollapseState()}isGroupCollapsed(e){const a=e??"null";return this.groupCollapseState[a]??!1}parseDateTime(e){return e?Array.isArray(e)&&e.length>=6?new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5],Math.floor(e[6]/1e6)):typeof e=="string"?new Date(e):new Date:new Date}templateConfig=W();setOrganizationMethod(e){this.organizationMethod=e,localStorage.setItem("sidebarOrganizationMethod",e)}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[TemplateStore] Starting to load plan template list...");const e=await b.getAllPlanTemplateConfigVOs();this.templateConfig.planTemplateList.value=e,this.templateServiceGroups.clear();for(const a of this.templateConfig.planTemplateList.value){const s=a.planTemplateId;if(s){const r=a.serviceGroup||"";r&&this.templateServiceGroups.set(s,r)}}console.log(`[TemplateStore] Successfully loaded ${this.templateConfig.planTemplateList.value.length} plan templates`)}catch(e){console.error("[TemplateStore] Failed to load plan template list:",e),this.templateConfig.planTemplateList.value=[];const a=e instanceof Error?e.message:"Unknown error";this.errorMessage=`Load failed: ${a}`}finally{this.isLoading=!1}}async selectTemplate(e){this.templateConfig.currentPlanTemplateId.value=e.planTemplateId||null,this.templateConfig.selectedTemplate.value=e,this.hasTaskRequirementModified=!1,console.log(`[TemplateStore] Selected plan template: ${e.planTemplateId}`)}async createNewTemplate(e){const a={planTemplateId:`new-${Date.now()}`,title:le.global.t("sidebar.newTemplateName"),planType:e,createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.templateConfig.selectedTemplate.value=a,this.templateConfig.currentPlanTemplateId.value=null,this.hasTaskRequirementModified=!1,console.log("[TemplateStore] Created new empty plan template")}async deleteTemplate(e){const a=e.planTemplateId;if(!a){console.warn("[TemplateStore] deleteTemplate: Invalid template object or ID");return}try{await b.deletePlanTemplate(a),this.templateConfig.currentPlanTemplateId.value===a&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[TemplateStore] Plan template ${a} has been deleted`)}catch(s){throw console.error("Failed to delete plan template:",s),await this.loadPlanTemplateList(),s}}clearSelection(){this.templateConfig.currentPlanTemplateId.value=null,this.templateConfig.selectedTemplate.value=null,this.hasTaskRequirementModified=!1}}const m=new ue,de=W(),d=M({isLoading:m.isLoading,errorMessage:m.errorMessage,hasTaskRequirementModified:m.hasTaskRequirementModified,organizationMethod:m.organizationMethod,templateServiceGroups:m.templateServiceGroups,groupCollapseState:m.groupCollapseState,loadGroupCollapseState:()=>m.loadGroupCollapseState(),saveGroupCollapseState:()=>m.saveGroupCollapseState(),toggleGroupCollapse:t=>{m.toggleGroupCollapse(t);const e=t??"null";d.groupCollapseState[e]=m.groupCollapseState[e],d.groupCollapseState={...d.groupCollapseState}},isGroupCollapsed:t=>m.isGroupCollapsed(t),parseDateTime:t=>m.parseDateTime(t),setOrganizationMethod:t=>{m.setOrganizationMethod(t),d.organizationMethod=t},loadPlanTemplateList:async()=>{await m.loadPlanTemplateList(),d.isLoading=m.isLoading,d.errorMessage=m.errorMessage,d.templateServiceGroups=m.templateServiceGroups},selectTemplate:t=>m.selectTemplate(t),createNewTemplate:t=>m.createNewTemplate(t),deleteTemplate:t=>m.deleteTemplate(t),clearSelection:()=>m.clearSelection()}),R=A(()=>{const t=[...de.planTemplateList.value].filter(e=>(e.accessLevel||(e.readOnly?"readOnly":"editable"))!=="readOnly");switch(d.organizationMethod){case"by_time":return t.sort((e,a)=>{const s=d.parseDateTime(e.updateTime??e.createTime);return d.parseDateTime(a.updateTime??a.createTime).getTime()-s.getTime()});case"by_abc":return t.sort((e,a)=>{const s=(e.title??"").toLowerCase(),r=(a.title??"").toLowerCase();return s.localeCompare(r)});case"by_group_time":case"by_group_abc":{const e=new Map,a=[];t.forEach(l=>{const i=l.planTemplateId||"",c=d.templateServiceGroups.get(i)??"";!c||c==="default"||c===""?a.push(l):(e.has(c)||e.set(c,[]),e.get(c).push(l))});const s=new Map;e.forEach((l,i)=>{const c=[...l];d.organizationMethod==="by_group_time"?c.sort((v,h)=>{const y=d.parseDateTime(v.updateTime??v.createTime);return d.parseDateTime(h.updateTime??h.createTime).getTime()-y.getTime()}):c.sort((v,h)=>{const y=(v.title??"").toLowerCase(),I=(h.title??"").toLowerCase();return y.localeCompare(I)}),s.set(i,c)}),d.organizationMethod==="by_group_time"?a.sort((l,i)=>{const c=d.parseDateTime(l.updateTime??l.createTime);return d.parseDateTime(i.updateTime??i.createTime).getTime()-c.getTime()}):a.sort((l,i)=>{const c=(l.title??"").toLowerCase(),v=(i.title??"").toLowerCase();return c.localeCompare(v)});const r=[];return r.push(...a),Array.from(s.keys()).sort().forEach(l=>{r.push(...s.get(l))}),r}default:return t.sort((e,a)=>{const s=d.parseDateTime(e.updateTime||e.createTime||"");return d.parseDateTime(a.updateTime||a.createTime||"").getTime()-s.getTime()})}}),me=A(()=>{if(d.organizationMethod!=="by_group_time"&&d.organizationMethod!=="by_group_abc")return new Map([[null,R.value]]);const t=new Map,e=[];R.value.forEach(n=>{const l=n.planTemplateId||"",i=d.templateServiceGroups.get(l)??"";!i||i==="default"||i===""?e.push(n):(t.has(i)||t.set(i,[]),t.get(i).push(n))});const s=new Map;return e.length>0&&s.set(null,e),Array.from(t.keys()).sort().forEach(n=>{s.set(n,t.get(n))}),s});Object.defineProperty(d,"sortedTemplates",{get:()=>R.value,enumerable:!0,configurable:!0});Object.defineProperty(d,"groupedTemplates",{get:()=>me.value,enumerable:!0,configurable:!0});export{H as D,ce as P,W as a,L as m,we as s,d as t,ke as u};
//# sourceMappingURL=templateStore-CL_yjOzv.js.map
